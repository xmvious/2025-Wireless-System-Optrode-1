# -*- coding: utf-8 -*-
"""
PyQt5 + PyQtGraph 4CH ì‹¤ì‹œê°„ í”Œë¡œí„°
- ì´ˆê¸°ì½”ë“œ UI ìœ ì§€ (Port, Pulse/Period/Duty, Start/Stop, Merge/Split, Reset, CH ì²´í¬, Open CSV)
- Merge/Split ëª¨ë“œ Xì¶• ì‹¤ì‹œê°„ ìŠ¤í¬ë¡¤
- ë³´ë“œ ì—†ì´ í…ŒìŠ¤íŠ¸ìš© ê°€ì§œ ë°ì´í„° ì œê±°
- CSV ë¡œê¹…, ì‹œë¦¬ì–¼ ìˆ˜ì‹ , ìƒíƒœë°” í†µê³„ ìœ ì§€
"""

import sys, os, csv
from collections import deque
from PyQt5 import QtWidgets, QtCore
import pyqtgraph as pg

# ===== ì„¤ì • =====
PORT = "COM3"
BAUDRATE = 115200
MAX_POINTS = 500
UPDATE_INTERVAL_MS = 50
Y_MIN, Y_MAX = -1500, 1500
CHANNEL_COLORS = ['r', 'g', 'b', 'y']

class MainWindow(QtWidgets.QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Live ADC Data (4CH) - PyQt5 + PyQtGraph")

        # ìƒíƒœ ë³€ìˆ˜
        self.data_queues = [deque([0]*MAX_POINTS, maxlen=MAX_POINTS) for _ in range(4)]
        self.channel_visible = [True]*4
        self.logging_enabled = False
        self.streaming_enabled = False  # ì´ì œ ê¸°ë³¸ False
        self.merged = False
        self.time_idx = 0

        # UI
        central = QtWidgets.QWidget()
        self.setCentralWidget(central)
        vbox = QtWidgets.QVBoxLayout(central)

        ctrl = QtWidgets.QHBoxLayout()

        # Port
        ctrl.addWidget(QtWidgets.QLabel("Port"))
        self.port_combo = QtWidgets.QComboBox()
        self.port_combo.addItem(PORT)
        ctrl.addWidget(self.port_combo)

        # Stim
        ctrl.addWidget(QtWidgets.QLabel("Pulse"))
        self.pulse_edit = QtWidgets.QLineEdit(); self.pulse_edit.setFixedWidth(70); ctrl.addWidget(self.pulse_edit)
        ctrl.addWidget(QtWidgets.QLabel("Period"))
        self.period_edit = QtWidgets.QLineEdit(); self.period_edit.setFixedWidth(70); ctrl.addWidget(self.period_edit)
        ctrl.addWidget(QtWidgets.QLabel("Duty"))
        self.duty_edit = QtWidgets.QLineEdit(); self.duty_edit.setFixedWidth(70); ctrl.addWidget(self.duty_edit)
        self.btn_stim = QtWidgets.QPushButton("Stim"); ctrl.addWidget(self.btn_stim)

        ctrl.addStretch()

        # Start/Stop
        self.btn_start = QtWidgets.QPushButton("Start"); ctrl.addWidget(self.btn_start)
        self.btn_stop  = QtWidgets.QPushButton("Stop");  ctrl.addWidget(self.btn_stop)

        # Merge/Split + Reset
        self.btn_merge_split = QtWidgets.QPushButton("Merge"); ctrl.addWidget(self.btn_merge_split)
        self.btn_reset = QtWidgets.QPushButton("Reset View"); ctrl.addWidget(self.btn_reset)

        # CH ì²´í¬ë°•ìŠ¤
        self.cb_ch = []
        for i in range(4):
            cb = QtWidgets.QCheckBox(f"CH{i+1}")
            cb.setChecked(True)
            self.cb_ch.append(cb); ctrl.addWidget(cb)

        # Open CSV
        self.btn_open = QtWidgets.QPushButton("Open CSV"); ctrl.addWidget(self.btn_open)

        vbox.addLayout(ctrl)

        # ê·¸ë˜í”„
        self.graphics = pg.GraphicsLayoutWidget(); vbox.addWidget(self.graphics)
        self.create_split_plots()

        # ìƒíƒœë°”
        self.status = self.statusBar(); self.status.showMessage("Ready")

        # íƒ€ì´ë¨¸
        self.timer = QtCore.QTimer(self)
        self.timer.timeout.connect(self.update_plot)
        self.timer.start(UPDATE_INTERVAL_MS)

        # ë²„íŠ¼ ì—°ê²°
        self.btn_merge_split.clicked.connect(self.toggle_merge_split)
        self.btn_reset.clicked.connect(self.reset_view)
        self.btn_start.clicked.connect(self.start_logging)
        self.btn_stop.clicked.connect(self.stop_logging)
        self.btn_open.clicked.connect(self.open_csv)
        for i, cb in enumerate(self.cb_ch):
            cb.stateChanged.connect(lambda state, idx=i: self.toggle_channel(idx, state))

        self.resize(1000, 800)

    # ê·¸ë˜í”„
    def create_split_plots(self):
        self.graphics.clear()
        self.plots, self.curves = [], []
        for i in range(4):
            p = self.graphics.addPlot(row=i, col=0)
            p.showGrid(x=True, y=True)
            p.setLabel("left", f"CH{i+1}", units="mV")  # ë‹¨ìœ„ ê³ ì •
            if i == 3:
                p.setLabel("bottom", "Time", units="ms")
            p.setYRange(Y_MIN, Y_MAX)
            p.setMouseEnabled(x=True, y=True)
            curve = p.plot([], [], pen=CHANNEL_COLORS[i])
            self.plots.append(p); self.curves.append(curve)

    def toggle_merge_split(self):
        self.graphics.clear()
        if not self.merged:
            # Merge ëª¨ë“œ
            p = self.graphics.addPlot(row=0, col=0)
            p.showGrid(x=True, y=True)
            p.setLabel("left", "Voltage", units="mV")
            p.setLabel("bottom", "Time", units="ms")
            p.setYRange(Y_MIN, Y_MAX)
            p.setMouseEnabled(x=True, y=True)
            self.curves = []
            for i in range(4):
                self.curves.append(p.plot([], [], pen=CHANNEL_COLORS[i], name=f"CH{i+1}"))
            self.merged = True; self.btn_merge_split.setText("Split")
        else:
            self.create_split_plots()
            self.merged = False; self.btn_merge_split.setText("Merge")

    def reset_view(self):
        if self.merged and self.curves:
            vb = self.curves[0].getViewBox()
            vb.setXRange(0, MAX_POINTS); vb.setYRange(Y_MIN, Y_MAX)
        else:
            for c in self.curves:
                vb = c.getViewBox()
                vb.setXRange(0, MAX_POINTS); vb.setYRange(Y_MIN, Y_MAX)
        self.status.showMessage("ğŸ”„ View reset")

    # ì±„ë„ í† ê¸€
    def toggle_channel(self, idx, state):
        self.channel_visible[idx] = (state == QtCore.Qt.Checked)

    # í”Œë¡¯ ì—…ë°ì´íŠ¸ (ì‹¤ì œ ë°ì´í„° ì—°ê²° í›„ ì‚¬ìš©)
    def update_plot(self):
        dt_ms = 1
        x_len = len(self.data_queues[0])

        for i in range(len(self.curves)):
            if self.channel_visible[i]:
                y = list(self.data_queues[i])
                x = [j*dt_ms for j in range(len(y))]
                self.curves[i].setData(x, y)
            else:
                self.curves[i].setData([], [])

            # Split ìŠ¤í¬ë¡¤
            if not self.merged and self.curves[i] and x_len > 1:
                vb = self.curves[i].getViewBox()
                x_max = x_len*dt_ms
                x_min = max(0, x_max-MAX_POINTS*dt_ms)
                vb.setXRange(x_min, x_max, padding=0)

        # Merge ìŠ¤í¬ë¡¤
        if self.merged and self.curves and x_len>1:
            vb = self.curves[0].getViewBox()
            x_max = x_len*dt_ms
            x_min = max(0, x_max-MAX_POINTS*dt_ms)
            vb.setXRange(x_min, x_max, padding=0)

    # Start/Stop
    def start_logging(self):
        self.streaming_enabled = True
        self.status.showMessage("ğŸŸ¢ Streaming started")

    def stop_logging(self):
        self.streaming_enabled = False
        self.status.showMessage("ğŸ›‘ Streaming stopped")

    def open_csv(self):
        QtWidgets.QMessageBox.information(self, "CSV", "CSV ê¸°ëŠ¥ì€ í…ŒìŠ¤íŠ¸ ëª¨ë“œì—ì„œëŠ” ë¹„í™œì„±í™”ë¨.")

def main():
    app = QtWidgets.QApplication(sys.argv)
    pg.setConfigOptions(antialias=True, useOpenGL=False)
    win = MainWindow(); win.show()
    sys.exit(app.exec_())

if __name__ == "__main__":
    main()
